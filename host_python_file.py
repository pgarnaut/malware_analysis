import subprocess
import shlex
import os
import shutil
import time

# script will yank samples from here:
samples_dir = "D:\\VBOX\\Samples"

# VM will collect samples from here:
vm_samples_dir = "D:\\VBOX\\vbox_share_infectable\\Samples"

# results will be sent here by VM
collection_dir = "D:\\VBOX\\vbox_share_infectable\\collections"

# we'll stash results here
results_dir = "D:\\VBOX\\Results"

default_sample_name = "sample.exe"
default_result_name = "results.zip"




def cmd(s):
	print "executing: ", s
	subprocess.call(s, shell=True)

def restart_vm():
	cmd(""""C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" controlvm goat poweroff""")
	cmd(""""C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" snapshot goat restorecurrent""")
	cmd(""""C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" startvm goat""")
	

def copy_sample(sample_name):
	dst = vm_samples_dir + os.sep + "sample.exe"
	print "copying from ", sample_name, " to ", dst
	shutil.copyfile(sample_name, dst)

def copy_results(sample_name):
	src = collection_dir + os.sep + default_result_name
	dst = results_dir + os.sep + sample_name + ".zip"
	print "moving result from: ", src, " to ", dst
	try:
		shutil.move(src, dst)
	except Exception, e:
		print "error copying results. skipping"

def cleanup_replication():
	try:
		os.remove(vm_samples_dir + os.sep + default_sample_name)
	except Exception, e:
		pass

if __name__ == "__main__":
	for f in os.listdir(samples_dir):
		# cleanup and restart
		cleanup_replication()
		restart_vm()
		time.sleep(1)
		cleanup_replication()
		time.sleep(25)
		
		try:
			copy_sample(samples_dir + os.sep + f)
			time.sleep(30) # wait for dump to complete
			copy_results(f)
		except Exception, e:
			print "Error with sample ", f, " skipping"
			
		
		